# Exercise 1: Understand the AVS deployment architecture

Azure VMware Solution offers a private cloud environment accessible from On-Premises and Azure-based resources. Services such as Azure ExpressRoute, VPN connections, or Azure Virtual WAN deliver the connectivity.

## Scenario

A large healthcare organization is struggling to securely connect and integrate its on-premises VMware workloads with new cloud-based applications in Azure, while maintaining internet access for essential tasks.

## Architecture diagram:

![](../Images/diagram-avs1.png)

## Lab objectives

In this exercise, you will complete the following tasks:

+ Task 1: Review the existing resources on the Azure portal 
+ Task 2: AVS Connectivity Options

### Task 1: Review the existing resources on the Azure portal

In this task, you will review the Pre-created resources on your Azure Portal.

1. In your web browser open `https://portal.azure.com/` and navigate to the **Azure portal** and sign in with your user credentials if you are not already signed in.
    * **Sign In Email/Username:** <inject key="AzureAdUserEmail"></inject>
    * **Sign In Password:** <inject key="AzureAdUserPassword"></inject>
3. On Azure portal, click on the **Resource groups** from the **Navigate** section.

    ![Navigate Resource Group](../Images/goto-rg.jpg)
    
4. From the **Resource group** page, notice the resource groups **AVS-RG** and **JumpBox-RG**.

    ![Launch AVS-DC](../Images/reviewrg.jpg)

5. Click on **AVS-RG** to view the resources present in it, you should see a resource of the **AVS Private Cloud** type named **AVS-DC**.

    ![Launch AVS-DC](../Images/launch-avs-dc1.jpg)

6. You will be utilizing **JumpBox-RG** for depolying and connecting to JumpBox **Virtual Machine**. 

    ![Launch AVS-DC](../Images/jumbox-rg.jpg)

### Task 2: Create and Connect to the JumpBox Virtual Machine

1. In the the **Azure portal** search for custom template **(1)** and select **Deploy a custom template (2)**.

   ![Jumpbox vm](../Images/4-1.png)

2. On the Custom deployment page, select **Built your own template in the editor**.

   ![Jumpbox vm](../Images/4-2.png)

3. On the **Edit template** page, remove the existing code and in place of that paste the following ARM template and click on **save**.

   ```Json
   {
     "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
     "contentVersion": "1.0.0.0",
     "parameters": {
       "adminUsername": {
         "type": "String"
       },
       "adminPassword": {
         "type": "SecureString"
       },
       "VirtualNetworkAddressPrefix": {
         "type": "String",
         "defaultValue": "10.0.0.0/16",
         "metadata": {
           "name": "Provide your vNet Address Prefix, later you will be connecting this vNet with Azure VMWare Solutions resource using ExpressRoute and Virtual Network Gateway."
         }
       },
       "JumpboxSubnetPrefix": {
         "type": "String",
         "defaultValue": "10.0.0.0/24",
         "metadata": {
           "name": "Provide JumpBox Subnet Prefix, will be used for JumpBox VM."
         }
       },
       "GatewaySubnetPrefix": {
         "type": "String",
         "defaultValue": "10.0.1.0/27",
         "metadata": {
           "name": "Provide your Gateway Subnet Address Prefix, which will be used for Virtual Network Gateway"
         }
       }
   
     },
     "variables": {
       "vmName": "[concat('JumpBox')]",
       "networkInterfaceName": "[concat(variables('vmName'), '-NIC')]",
       "networkSecurityGroupName": "[concat(variables('vmName'), '-NSG')]",
       "publicIpAddressDNSName": "[toLower( concat( 'jumpbox', uniqueString(resourceGroup().id) ) )]",
       "publicIpAddressName": "[concat(variables('vmName'), '-PIP')]",
       "virtualNetworkName": "JumpBox-vNet",
       "JumpboxsubnetName": "Jumpbox",
       "GatewaySubnet": "GatewaySubnet",
       "subnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets/',variables('virtualNetworkName'), variables('JumpboxsubnetName'))]",
       "virtualMachineSize": "Standard_D2s_v3",
       "location": "[resourceGroup().location]",
       "avs-gw-name": "AVS-GW",
       "avs-gw-ip-name": "AVS-GW-PIP"
     },
     "resources": [
       {
         "type": "Microsoft.Network/virtualNetworks",
         "apiVersion": "2020-11-01",
         "name": "[variables('virtualNetworkName')]",
         "location": "[variables('location')]",
         "properties": {
           "addressSpace": {
             "addressPrefixes": [
               "[parameters('VirtualNetworkAddressPrefix')]"
             ]
           },
           "subnets": [
             {
               "name": "[variables('JumpboxsubnetName')]",
               "properties": {
                 "addressPrefix": "[parameters('JumpboxSubnetPrefix')]"
               }
             },
             {
               "name": "[variables('GatewaySubnet')]",
               "properties": {
                 "addressPrefix": "[parameters('GatewaySubnetPrefix')]"
               }
             }
           ]
         }
       },
       {
         "apiVersion": "2020-11-01",
         "name": "[variables('avs-gw-name')]",
         "type": "Microsoft.Network/virtualNetworkGateways",
         "location": "[variables('location')]",
         "dependsOn": [
           "[concat('Microsoft.Network/publicIPAddresses/', variables('avs-gw-ip-name'))]",
           "[concat('Microsoft.Network/networkInterfaces/', variables('networkInterfaceName'))]"
         ],
         "tags": {},
         "properties": {
           "gatewayType": "ExpressRoute",
           "ipConfigurations": [
             {
               "name": "default",
               "properties": {
                 "privateIPAllocationMethod": "Dynamic",
                 "subnet": {
                   "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets/',variables('virtualNetworkName'), variables('GatewaySubnet'))]"
                 },
                 "publicIpAddress": {
                   "id": "[resourceId(resourceGroup().name, 'Microsoft.Network/publicIPAddresses', variables('avs-gw-ip-name'))]"
                 }
               }
             }
           ],
           "sku": {
             "name": "Standard",
             "tier": "Standard"
           }
         }
       },
       {
         "apiVersion": "2020-08-01",
         "type": "Microsoft.Network/publicIPAddresses",
         "name": "[variables('avs-gw-ip-name')]",
         "location": "[variables('location')]",
         "properties": {
           "publicIPAllocationMethod": "Static"
         },
         "sku": {
           "name": "Standard"
         }
       },
       {
         "type": "Microsoft.Compute/virtualMachines",
         "apiVersion": "2021-07-01",
         "name": "[variables('vmName')]",
         "location": "[variables('location')]",
         "dependsOn": [
           "[concat('Microsoft.Network/networkInterfaces/', variables('networkInterfaceName'))]"
         ],
         "properties": {
           "osProfile": {
             "computerName": "[variables('vmName')]",
             "adminUsername": "[parameters('adminUsername')]",
             "adminPassword": "[parameters('adminPassword')]",
             "windowsConfiguration": {
               "provisionVmAgent": true,
               "enableAutomaticUpdates": false
             }
           },
           "hardwareProfile": {
             "vmSize": "[variables('virtualMachineSize')]"
           },
           "storageProfile": {
             "imageReference": {
               "publisher": "MicrosoftWindowsServer",
               "offer": "WindowsServer",
               "sku": "2022-datacenter-azure-edition",
               "version": "latest"
             },
             "osDisk": {
               "createOption": "fromImage",
               "name": "[concat(variables('vmName'), '-osdisk')]",
               "managedDisk": {
                 "storageAccountType": "Premium_LRS"
               }
             },
             "dataDisks": []
           },
           "networkProfile": {
             "networkInterfaces": [
               {
                 "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
               }
             ]
           }
         }
       },
       {
         "type": "Microsoft.Compute/virtualMachines/extensions",
         "apiVersion": "2021-07-01",
         "name": "[concat(variables('vmName'),'/', 'winExtension')]",
         "location": "[resourceGroup().location]",
         "dependsOn": [
           "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
         ],
         "tags": {
           "displayName": "VM Extension"
         },
         "properties": {
           "publisher": "Microsoft.Compute",
           "type": "CustomScriptExtension",
           "typeHandlerVersion": "1.8",
           "autoUpgradeMinorVersion": true,
           "settings": {
             "fileUris": [
               "https://experienceazure.blob.core.windows.net/templates/azure-vmware-solution/scripts/jumpboxazureportal.ps1"
             ]
           },
           "protectedSettings": {
             "commandToExecute": "[concat('powershell.exe -ExecutionPolicy Unrestricted -File azure-vmware-solution/scripts/jumpboxazureportal.ps1' )]"
           }
         }
       },
       {
         "type": "Microsoft.Network/networkSecurityGroups",
         "apiVersion": "2019-02-01",
         "name": "[variables('networkSecurityGroupName')]",
         "location": "[variables('location')]",
         "properties": {
           "securityRules": [
             {
               "name": "default-allow-rdp",
               "properties": {
                 "priority": 110,
                 "protocol": "TCP",
                 "access": "Allow",
                 "direction": "Inbound",
                 "sourceAddressPrefix": "*",
                 "sourcePortRange": "*",
                 "destinationAddressPrefix": "*",
                 "destinationPortRange": "3389"
               }
             }
           ]
         }
       },
       {
         "type": "Microsoft.Network/publicIpAddresses",
         "apiVersion": "2019-02-01",
         "name": "[variables('publicIpAddressName')]",
         "location": "[variables('location')]",
         "properties": {
           "publicIpAllocationMethod": "Dynamic",
           "dnsSettings": {
             "domainNameLabel": "[concat(variables('publicIpAddressDNSName'))]"
           }
         }
       },
       {
         "type": "Microsoft.Network/networkInterfaces",
         "apiVersion": "2021-03-01",
         "name": "[variables('networkInterfaceName')]",
         "location": "[variables('location')]",
         "dependsOn": [
           "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
           "[concat('Microsoft.Network/publicIpAddresses/', variables('publicIpAddressName'))]",
           "[concat('Microsoft.Network/networkSecurityGroups/', variables('networkSecurityGroupName'))]"
         ],
         "properties": {
           "ipConfigurations": [
             {
               "name": "ipconfig1",
               "properties": {
                 "subnet": {
                   "id": "[variables('subnetRef')]"
                 },
                 "privateIPAllocationMethod": "Dynamic",
                 "publicIpAddress": {
                   "id": "[resourceId(resourceGroup().name,'Microsoft.Network/publicIpAddresses', variables('publicIpAddressName'))]"
                 }
               }
             }
           ],
           "networkSecurityGroup": {
             "id": "[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]"
           }
         }
       }
     ],
     "outputs": {
       "JumpBox DNS Name": {
         "type": "String",
         "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses',variables('publicIpAddressName'))).dnsSettings.fqdn]"
       },
       "JumpBox Admin Username": {
         "type": "String",
         "value": "[parameters('adminUsername')]"
       },
       "JumpBox Admin Password": {
         "type": "String",
         "value": "[parameters('adminPassword')]"
       }
     }
   }

   ```
   
   ![Jumpbox vm](../Images/4-3.png)

4. Once you clicked on **save**, you will see the **Custom deployment** page. On this page, select/provide following value:
   * Subscription: **Dedicated Sub - 1101**
   * Resource Group: select existing **JumpBox-RG**
   * Region: **East US**
   * Admin Username: `demouser`
   * Admin Password: `Password.1!!`
   * Virtual Network Address Prefix: `10.0.0.0/16`
   * Jumpbox Subnet Prefix: `10.0.0.0/24`
   * Gateway Subnet Prefix: `10.0.1.0/27`
   > Now click on **Review + create** button.

   ![Jumpbox vm](../Images/ARMReviewCreate.png)

6. Now, template validation will run. Once validation is completed, click on **Create** and wait for the deployment to complete. The deployment process would take approximately 20-30 minutes.

   ![Jumpbox vm](../Images/ARMCreate.png)

7. Once the deployment is completed, navigate to the resource group by clicking on **Go to resource group**.

   ![Jumpbox vm](../Images/4-7.png)

8. In the **JumpBox-RG** Overview page, select **JumpBox** virtual machine.

   ![Jumpbox vm](../Images/4-9.png)

9. In the JumpBox virtual machine blade, click on **Connect** and then click on **Download RDP file**.

   ![Jumpbox vm](../Images/4-8.png)

10. Open the JumpBox.rdp file from the downloads.

    ![Jumpbox vm](../Images/4-10.png)

11. Open the downloaded RDP file and select Connect when prompted. You will get a warning that the .rdp file is from an unknown publisher. This is expected. In the Remote Desktop Connection window, select **Connect** to continue.

    ![Jumpbox vm](../Images/4-11.png)

12. In the Windows Security window, select More Choices and then Use a different account. Enter the username as `.\demouser` and password `Password.1!!` for an account on the virtual machine and then select **OK**.
    
    ![Jumpbox vm](../Images/RDPConnect.png)

14. Select **Yes** to verify the identity of the virtual machine and finish logging on.

    ![Jumpbox vm](../Images/4-13.png)

15. You are now successfully connected to the **JumpBox** virtual machine.

### Task 3: AVS Connectivity Options

In this section, you will create a connection between an existing, non-AVS Virtual Network in Azure and the Azure VMware Solution environment. This allows the JumpBox virtual machine you created to manage key components in the VMware management plane such as vCenter, HCX, and NSX-T. You will also be able to access Virtual Machines deployed in AVS and allow those VMs to access resources deployed in the Hub or Spoke VNet’s, such as Private Endpoints and other Azure VMs or Services.

**Summary**: Generate a new Authorization Key in the AVS ExpressRoute settings, and then create a new Connection from the Virtual Network Gateway in the VNet where the JumpBox is connected.

### Option 1: Internal ExpressRoute Setup from AVS -> VNet

 > **NOTE**: Since we already have a virtual network gateway, you’ll add a connection between it and your Azure VMware Solution private cloud.

1. On your virtual machine, click on the Azure Portal icon, as shown below:
 
    ![Launch Azure Portal](../Images/gG.png)
 
2. You'll see the **Sign into Microsoft Azure** tab. Here, enter your credentials:
 
   - **Email/Username:** <inject key="AzureAdUserEmail"></inject>
 
    ![Enter Your Username](../Images/gH.png)
 
3. Next, provide your password:
 
   - **Password:** <inject key="AzureAdUserPassword"></inject>
 
   ![Enter Your Password](../Images/gI.png)
 
4. If prompted to stay signed in, you can click "No."

5. If you are prompted with a window for MFA, click on **Ask Later**.

6. If a **Welcome to Microsoft Azure** pop-up window appears, simply click "Maybe Later" to skip the tour.

1. On Azure portal, click on the **Resource groups** from the **Navigate** section. 

   ![Navigate Resource Group](../Images/goto-rg.jpg)
   
2. From the **Resource group** page, open **AVS-RG** by clicking on it.
  
   ![Navigate AVS-RG Resource Group](../Images/select-avs-rg.jpg)
   
4. Now, you can see the resources in **AVS-RG**, select **AVS-DC** resource of **AVS Private cloud** type.

   ![Launch AVS-DC](../Images/launch-avs-dc1.jpg)
   
5. From **AVS-DC** blade, click on **VMware credentials** (1), then copy **Web client URL of vCenter Server**.

   ![copy web client URL](../Images/vCenterWebClientURLcopy.jpg)
   
6. Now, open the new tab in **Edge** browser in **JumpBox** and paste the **Web client URL of vCenter Server**. You will see it is not available because there is no connectivity with AVS-DC VMware private cloud yet. In the next step you will start configuring the connectivity on **AVS-DC** with **JumpBOX-vNet** using Azure Virtual Gateway.

   ![Open web client URL](../Images/vCenterWebClientURLopen.jpg)
   
7. From **AVS-DC** blade, click on **Connectivity** option under **Manage** section and then select **ExpressRoute** from the available connectivity options. In the last, click on **+ Request an authorization key**.

   ![Request an authorization key](../Images/req-key.jpg)
   
8. Give your authorization key a name: `az-vnet-key`. Click **Create**. It may take about 30 seconds to create the key. Save the key in notepad to use in next exercise.

   ![Create authorization key](../Images/create-auth-key.jpg)
    
## Review
In this exercise, you have completed:
- Reviewed the existing resources on the Azure portal 

## References:
[Tutorial - create azure virtual machine | Microsoft Docs](https://learn.microsoft.com/en-us/azure/virtual-machines/windows/quick-create-portal)


